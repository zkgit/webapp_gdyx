var wxshare = {
	options: {
		m: false,
		title:"天翼高清微助手",
		logourl:"http://jsitvwx.cnitv.net/jsdxitv_vcms/image_space/logo.png",
		info:"小屏掌控大屏，电视新鲜玩法",
		url:serverBase,
		debug:false
	},
	init: function(data) {
		this.initEvent_();
		if(data.title!=""&&data.title!=undefined){
			this.options.title=data.title;
		}
		if(data.logourl!=""&&data.logourl!=undefined){
			this.options.logourl=data.logourl;
		}
		if(data.info!=""&&data.info!=undefined){
			this.options.info=data.info;
		}
		if(data.url!=""&&data.url!=undefined){
			this.options.url=data.url;
		}
		if(data.debug!=""&&data.debug!=undefined){
			this.options.debug=data.debug;
		}
	},
	initEvent_: function() {
		newget();
		this.config_();
	},
	check_: function(url) {
		if (url.indexOf("detial") == -1) {
			this.weixinshare_(wxshare.options.title, wxshare.options.logourl, wxshare.options.info,url);
		}
	},
	config_: function() {
		var url = encodeURIComponent(window.location.href.split('#')[0]);
		var weixinurl = webset.base + 'wxtv/jsapiTicket';
		var data = {
			url: url
		}
		$.get(weixinurl, data, function(e) {
			var appId = e.appid;
			$.cookie('appId', appId);
			wxshare.check_(url);
			var timestamp = e.timestamp;
			var nonceStr = e.nonceStr;
			var signature = e.signature;
			wx.config({
				debug: wxshare.options.debug,
				appId: appId, // 公众号的唯一标识
				timestamp: timestamp, // 生成签名的时间戳
				nonceStr: nonceStr, // 生成签名的随机串
				signature: signature, // 签名
				jsApiList: ['onMenuShareTimeline',
					'onMenuShareAppMessage',
					'scanQRCode'
				] // 需要使用的JS接口列表
			});
		})
	},
	ready_: function(str) {
		wxready(str);
	},
	error_: function() {
		wxerror();
	},
	weixinshare_: function(sharetitle, shareimgurl, sharedesc, url,str) {
		var appId = $.cookie('appId');
		var OpenId = $.query()['openId'] ? $.query()['openId'] : '';
		var url=window.location.href;
		//去除对应的参数
		if (url.indexOf('?1=1') > -1) {
			url = url.replace('?1=1', '');
		}
		if (url.indexOf('&1=1') > -1) {
			url = url.replace('?1=1', '');
		}
		if (url.indexOf('&from=timeline') > -1) {
			url = url.replace('&from=timeline&isappinstalled=0', '');
		}
		if (url.indexOf('&from=groupmessage') > -1) {
			url = url.replace('&from=groupmessage&isappinstalled=0', '');
		}
		if (url.indexOf('&from=singlemessage') > -1) {
			url = url.replace('&from=groupmessage&isappinstalled=0', '');
		}
		if (url.indexOf('?openId=' + OpenId) > -1) {
			url = url.replace('?openId=' + OpenId, '');
		}
		
		$.cookie('relUrl', url);
		$.cookie('sharedesc', sharedesc);
		$.cookie('sharetitle', sharetitle);
		$.cookie('shareimgurl', shareimgurl);
		wxshare.ready_(str);
		wxshare.error_();
	}
}
//微信分享
function newget() {
	$.get = function(url, data, success, error) {
		if (jQuery.isFunction(data)) {
			error = success;
			success = data;
			data = undefined;
		}
		url = encodeURI(url);
		jQuery.ajax({
			url: url,
			type: "get",
			dataType: "json",
			cache: false,
			data: data,
			success: success,
			error: error
		});
	}
	$.query = function () {
		var aQuery = window.location.href.split("?");  //取得Get参数
		var aGET = new Array();
		if (aQuery.length > 1) {
			var aQuery=aQuery[1].split("#");
			var aBuf = aQuery[0].split("&");
			for (var i = 0, iLoop = aBuf.length; i < iLoop; i++) {
				var aTmp = aBuf[i].split("=");  //分离key与Value
				aGET[aTmp[0]] = aTmp[1];
			}
		}
		return aGET;
	}
}

function wxready(str) {
	wx.ready(function() {
		wxshare.options.m = "true";
		var url=encodeURIComponent($.cookie('relUrl'));
		var imgUrl=$.cookie('shareimgurl').split("!")[0];
		var title=$.cookie('sharetitle');
		if($.cookie('sharetitle')!='天翼高清微助手'){
			title= '我在看【'+$.cookie('sharetitle')+'】，一起来聊个五毛钱的......'
		}
		//分享朋友圈
		wx.onMenuShareTimeline({
			title:title,
			link: "http://jsitvwx.cnitv.net/jsdxitv-wxtv/wxtv/redirUrl?url="+url,
			imgUrl: imgUrl,
			success:function () {
			},
			cancel:function () {
			}
		});
		wx.onMenuShareAppMessage({
			title: $.cookie('sharetitle'),
			desc: $.cookie('sharedesc'),
			link: "http://jsitvwx.cnitv.net/jsdxitv-wxtv/wxtv/redirUrl?url="+url,
			imgUrl: imgUrl,
			success:function () {
			},
			cancel:function () {
			}
		});
	});
}

function wxerror() {
	wx.error(function(res) {
		if (wxshare.options.m == "true") {
			wxshare.options.m = "false";
			this.config_();
		}
	});
}